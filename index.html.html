<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ฟอร์มสั่งอาหารสำหรับลูกค้า</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font for Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .container {
            max-width: 800px;
        }
        .menu-item-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        .menu-item-info {
            flex-grow: 1;
        }
        .menu-item-quantity {
            width: 80px; /* Fixed width for quantity input */
            text-align: center;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db; /* gray-300 */
            padding: 0.25rem 0.5rem;
        }
        /* Custom Alert Modal */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-lg */
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
         .loading-overlay {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex items-center justify-center">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p class="ml-4 text-gray-700">กำลังโหลดข้อมูล...</p>
    </div>

    <div class="container mx-auto p-6 bg-white shadow-lg rounded-xl">
        <h1 class="text-3xl font-bold text-teal-600 mb-6 text-center">ฟอร์มสั่งอาหาร</h1>
        <p class="text-gray-600 mb-6 text-center">เลือกเมนูอาหารและปรับแต่งตามความต้องการของคุณ</p>

        <!-- Custom Alert Modal -->
        <div id="customAlertModal" class="modal hidden">
            <div class="modal-content">
                <span id="closeAlertButton" class="close-button">&times;</span>
                <p id="customAlertMessage" class="text-lg text-gray-700"></p>
                <button id="okAlertButton" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">ตกลง</button>
            </div>
        </div>

        <form id="customerOrderForm">
            <div class="mb-6 p-4 bg-blue-50 rounded-lg shadow-inner">
                <h2 class="text-xl font-semibold text-blue-800 mb-4">ข้อมูลลูกค้า</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-full">
                        <label for="customerName" class="block text-sm font-medium text-gray-700">ชื่อลูกค้า:</label>
                        <input type="text" id="customerName" placeholder="ชื่อลูกค้า (ไม่บังคับ)"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div class="col-span-full">
                        <label for="customerAddress" class="block text-sm font-medium text-gray-700">บ้านเลขที่:</label>
                        <input type="text" id="customerAddress" placeholder="บ้านเลขที่ (ไม่บังคับ)"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div class="col-span-full">
                        <label for="customerPhone" class="block text-sm font-medium text-gray-700">เบอร์โทร:</label>
                        <input type="tel" id="customerPhone" placeholder="เบอร์โทรศัพท์ (ไม่บังคับ)"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                </div>
            </div>

            <div class="mb-6 p-4 bg-green-50 rounded-lg shadow-inner">
                <h2 class="text-xl font-semibold text-green-800 mb-4">เลือกเมนูอาหาร</h2>
                <div id="menuItemsContainer" class="space-y-3">
                    <p id="loadingMenuMessage" class="text-gray-500 text-center">กำลังโหลดเมนู...</p>
                    <p id="noRecipesFoundMessage" class="text-gray-500 text-center hidden">ยังไม่มีเมนูอาหารในระบบ</p>
                    <!-- Menu items will be dynamically loaded here, now with quantity selection directly in the loop -->
                </div>
                <div id="selectedMenuItemDetails" class="mt-4 p-3 bg-green-100 rounded-md hidden">
                    <h3 class="text-lg font-semibold text-green-800">รายละเอียดเมนูที่เลือก:</h3>
                    <p class="text-gray-700"><strong>เมนู:</strong> <span id="selectedMenuName"></span></p>
                    <p class="text-gray-700"><strong>จำนวน:</strong> <input type="number" id="selectedMenuQuantity" value="1" min="1" step="1" class="menu-item-quantity inline-block w-20 ml-2 py-1 px-2 text-sm"></p>
                </div>
            </div>

            <!-- New Customization Sections (Styling adjusted to be simpler as per new image) -->
            <div id="customizationOptions" class="hidden space-y-6">
                <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">3. วัตถุดิบหลัก <span class="text-red-500">*</span></h2>
                    <p class="text-gray-600 mb-3">Please select 5 options.</p>
                    <div id="mainIngredientsContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <!-- Main ingredients will be rendered here -->
                    </div>
                </div>

                <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">4. น้ำยา <span class="text-red-500">*</span></h2>
                    <div id="soupBaseContainer" class="space-y-2">
                        <!-- Soup base options will be rendered here -->
                    </div>
                </div>

                <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">5. ระดับความเผ็ด <span class="text-red-500">*</span></h2>
                    <div id="spicinessContainer" class="space-y-2">
                        <!-- Spiciness options will be rendered here -->
                    </div>
                </div>

                <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">6. ผัก <span class="text-red-500">*</span></h2>
                    <div id="vegetablesContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <!-- Vegetables will be rendered here -->
                    </div>
                </div>

                <!-- 7. หมายเหตุ Section -->
                <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">7. หมายเหตุ</h2>
                    <textarea id="customerRemarks" placeholder="Enter your answer" rows="4"
                              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                </div>
            </div>

            <!-- Total Price Display -->
            <p id="totalPriceDisplay" class="text-2xl font-bold text-red-600 text-center mt-6 mb-4">
                ราคารวม: 0.00 บาท
            </p>

            <!-- Total Cost Display (New) -->
            <p id="totalCostDisplay" class="text-lg font-semibold text-gray-700 text-center mt-2 mb-4">
                ต้นทุนโดยประมาณ: 0.00 บาท
            </p>

            <div class="text-center mt-6">
                <button type="submit"
                        class="px-8 py-3 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    สั่งซื้อ
                </button>
            </div>
        </form>
    </div>

    <!-- Firebase CDN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Global Variables ---
        let firebaseApp = null;
        let db = null;
        let auth = null;
        let userId = null;
        let isFirebaseReady = false;
        let appId = null;

        // --- Global Data Storage ---
        let availableRecipes = []; // Stores recipes fetched from Firestore
        let selectedRecipe = null; // Stores the currently selected recipe object

        // --- Customization Options Data (Hardcoded for this example based on the image) ---
        // In a real application, these might also be fetched from Firestore.
        const mainIngredientsOptions = [
            { name: 'หมูยอ', price: 0 },
            { name: 'ลูกชิ้นปลา', price: 0 },
            { name: 'ไส้กรอกหนังกรอบ', price: 0 },
            { name: 'เต้าหู้ปลา', price: 0 },
            { name: 'หมูสับ', price: 0 },
            { name: 'ปูอัด', price: 0 },
            { name: 'กุ้ง', price: 20 },
            { name: 'ปลาหมึก', price: 20 },
            { name: 'หอยแครง', price: 30 },
            { name: 'แมงกะพรุน', price: 30 },
            { name: 'แซลมอน', price: 30 }
        ];

        const soupBaseOptions = ['ไม่ปลาร้า', 'ปลาร้า'];

        const spicinessOptions = [
            'ไม่เผ็ด',
            'เผ็ดน้อย',
            'เผ็ดกลาง (ปกติของร้าน)',
            'เผ็ดมาก',
            'แยกพริก'
        ];

        const vegetablesOptions = [
            'มะเขือเทศ',
            'หอมหัวใหญ่',
            'หอมแขก',
            'หอมแดง',
            'ขึ้นฉ่าย',
            'ผักชีฝรั่ง',
            'แครอท',
            'ถั่วฝักยาว',
            'ข้าวโพดอ่อน',
            'เห็ดฟาง',
            'เห็ดเข็มทอง',
            'เห็ดชิเมจิ',
            'ใส่ทุกอย่าง'
        ];

        // --- DOM Elements ---
        const customerOrderForm = document.getElementById('customerOrderForm');
        const customerNameInput = document.getElementById('customerName');
        const customerAddressInput = document.getElementById('customerAddress'); // New
        const customerPhoneInput = document.getElementById('customerPhone');     // New
        const menuItemsContainer = document.getElementById('menuItemsContainer');
        const loadingMenuMessage = document.getElementById('loadingMenuMessage');
        const noRecipesFoundMessage = document.getElementById('noRecipesFoundMessage');
        const loadingOverlay = document.getElementById('loadingOverlay');

        const selectedMenuItemDetails = document.getElementById('selectedMenuItemDetails');
        const selectedMenuNameSpan = document.getElementById('selectedMenuName');
        const selectedMenuQuantityInput = document.getElementById('selectedMenuQuantity');

        const customizationOptionsDiv = document.getElementById('customizationOptions');
        const mainIngredientsContainer = document.getElementById('mainIngredientsContainer');
        const soupBaseContainer = document.getElementById('soupBaseContainer');
        const spicinessContainer = document.getElementById('spicinessContainer');
        const vegetablesContainer = document.getElementById('vegetablesContainer');
        const customerRemarksInput = document.getElementById('customerRemarks'); // New
        const totalPriceDisplay = document.getElementById('totalPriceDisplay'); // New
        const totalCostDisplay = document.getElementById('totalCostDisplay'); // New element for cost

        // Custom Alert Modal
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const closeAlertButton = document.getElementById('closeAlertButton');
        const okAlertButton = document.getElementById('okAlertButton');

        // --- Firebase Initialization ---
        async function initFirebase() {
            loadingOverlay.style.display = 'flex'; // Show loading
            try {
                // *** สำคัญ: คุณต้องเปลี่ยนค่าเหล่านี้ให้เป็น Firebase Config ของโปรเจกต์ของคุณเอง ***
                // ก๊อปปี้ Object นี้ { ... } จาก Firebase Console -> Project settings -> Your apps -> Web app
                // แล้ววางแทนที่ Object ว่างเปล่าด้านล่าง (ลบบรรทัดเดิมทิ้ง และวาง config ของคุณแทน)
                const firebaseConfig = {
  apiKey: "AIzaSyAGv11Z1zCmxT6OU7U1S1FJ21o_GSKoeKY",
  authDomain: "diy-salad.firebaseapp.com",
  projectId: "diy-salad",
  storageBucket: "diy-salad.firebasestorage.app",
  messagingSenderId: "934489993760",
  appId: "1:934489993760:web:481fb2b6bf9748bb540245",
  measurementId: "G-JXX15EF4KE"
};
                // *** สิ้นสุดส่วนที่ต้องแก้ไข ***

                if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey || !firebaseConfig.authDomain) {
                    console.error("Firebase config is missing or incomplete (apiKey or authDomain). Data will not be loaded/saved.");
                    loadingOverlay.style.display = 'none';
                    showCustomAlert("ระบบฐานข้อมูลไม่พร้อมใช้งาน. โปรดตรวจสอบ Firebase Config ของคุณ.");
                    return;
                }

                // Use __app_id provided by Canvas environment, fallback to firebaseConfig.projectId
                appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
                console.log("Using appId:", appId);

                firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp);

                // Sign in anonymously for customer-facing form
                await signInAnonymously(auth);
                userId = auth.currentUser?.uid; // Will be anonymous user ID
                isFirebaseReady = true;
                console.log("Firebase initialized for customer form. Anonymous User ID:", userId);
                loadingOverlay.style.display = 'none';

                initFirestoreListeners();
                renderCustomizationOptions(); // Render customization options once Firebase is ready
            } catch (error) {
                console.error("Error initializing Firebase for customer form:", error);
                showCustomAlert("เกิดข้อผิดพลาดในการโหลดระบบ: " + error.message);
                loadingOverlay.style.display = 'none';
            }
        }

        // --- Firestore Listeners ---
        function initFirestoreListeners() {
            if (!isFirebaseReady) return;

            // Listen for changes in public recipes
            // IMPORTANT: For this to work, Firebase Security Rules must allow public read on `public_recipes`.
            // Example rule: `match /artifacts/{appId}/public_recipes/{document=**} { allow read: if true; }`
            const publicRecipesColRef = collection(db, `artifacts/${appId}/public_recipes`);
            loadingMenuMessage.classList.remove('hidden');
            noRecipesFoundMessage.classList.add('hidden');

            onSnapshot(publicRecipesColRef, (snapshot) => {
                availableRecipes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Available recipes loaded for customer form:", availableRecipes);
                renderMenuItems();
                loadingMenuMessage.classList.add('hidden');
                if (availableRecipes.length === 0) {
                    noRecipesFoundMessage.classList.remove('hidden');
                } else {
                    noRecipesFoundMessage.classList.add('hidden');
                }
                calculateTotalPrice(); // Recalculate price if recipes change
            }, (error) => {
                console.error("Error fetching recipes for customer form:", error);
                loadingMenuMessage.classList.add('hidden');
                noRecipesFoundMessage.classList.remove('hidden'); // Show message even on error
                showCustomAlert("ไม่สามารถโหลดเมนูอาหารได้. โปรดตรวจสอบการตั้งค่า Firebase Security Rules สำหรับ collection 'public_recipes'.");
            });
        }

        // --- Render Menu Items ---
        function renderMenuItems() {
            menuItemsContainer.innerHTML = ''; // Clear existing items
            if (availableRecipes.length === 0) {
                 noRecipesFoundMessage.classList.remove('hidden');
                 return;
            } else {
                noRecipesFoundMessage.classList.add('hidden');
            }

            availableRecipes.forEach(recipe => {
                const menuItemCard = document.createElement('div');
                menuItemCard.className = 'menu-item-card cursor-pointer hover:bg-gray-100 transition duration-150 ease-in-out';
                menuItemCard.dataset.recipeId = recipe.id; // Store recipe ID
                menuItemCard.innerHTML = `
                    <div class="menu-item-info">
                        <h3 class="text-lg font-semibold text-gray-800">${recipe.finishedGoodName}</h3>
                        <p class="text-gray-600">ราคาเริ่มต้น: ${recipe.sellingPricePerUnit ? recipe.sellingPricePerUnit.toFixed(2) : 'N/A'} บาท</p>
                    </div>
                `;
                menuItemsContainer.appendChild(menuItemCard);

                menuItemCard.addEventListener('click', () => {
                    selectMenuItem(recipe.id);
                });
            });
            // Auto-select the first item if available
            if (availableRecipes.length > 0) {
                selectMenuItem(availableRecipes[0].id);
            }
        }

        /**
         * Handles selecting a menu item.
         * @param {string} recipeId The ID of the selected recipe.
         */
        function selectMenuItem(recipeId) {
            selectedRecipe = availableRecipes.find(r => r.id === recipeId);
            if (selectedRecipe) {
                // Highlight selected card
                menuItemsContainer.querySelectorAll('.menu-item-card').forEach(card => {
                    if (card.dataset.recipeId === recipeId) {
                        card.classList.add('border-2', 'border-blue-500');
                    } else {
                        card.classList.remove('border-2', 'border-blue-500');
                    }
                });

                selectedMenuNameSpan.textContent = selectedRecipe.finishedGoodName;
                selectedMenuItemDetails.classList.remove('hidden');
                customizationOptionsDiv.classList.remove('hidden'); // Show customization options
                calculateTotalPrice(); // Recalculate price when menu item changes
            } else {
                selectedMenuItemDetails.classList.add('hidden');
                customizationOptionsDiv.classList.add('hidden');
                calculateTotalPrice(); // Recalculate price (should become 0 if no item selected)
            }
        }

        // --- Render Customization Options ---
        function renderCustomizationOptions() {
            // Main Ingredients
            mainIngredientsContainer.innerHTML = '';
            mainIngredientsOptions.forEach(option => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'flex items-center';
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="mainIng-${option.name.replace(/\s|\(|\)/g, '')}" name="mainIngredient" value="${option.name}"
                           data-price="${option.price}" class="h-4 w-4 text-yellow-600 focus:ring-yellow-500 border-gray-300 rounded main-ingredient-checkbox">
                    <label for="mainIng-${option.name.replace(/\s|\(|\)/g, '')}" class="ml-2 block text-sm text-gray-900">
                        ${option.name} ${option.price > 0 ? ` (+${option.price} บาท)` : ''}
                    </label>
                `;
                mainIngredientsContainer.appendChild(checkboxDiv);
            });
            // Add event listener for main ingredients to enforce 5 selection limit
            mainIngredientsContainer.querySelectorAll('.main-ingredient-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    enforceMainIngredientLimit();
                    calculateTotalPrice(); // Recalculate price when main ingredients change
                });
            });


            // Soup Base
            soupBaseContainer.innerHTML = '';
            soupBaseOptions.forEach((option, index) => {
                const radioDiv = document.createElement('div');
                radioDiv.className = 'flex items-center';
                radioDiv.innerHTML = `
                    <input type="radio" id="soupBase-${option.replace(/\s|\(|\)/g, '')}" name="soupBase" value="${option}"
                           class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300" ${index === 0 ? 'checked' : ''}>
                    <label for="soupBase-${option.replace(/\s|\(|\)/g, '')}" class="ml-2 block text-sm text-gray-900">${option}</label>
                `;
                soupBaseContainer.appendChild(radioDiv);
            });
            soupBaseContainer.addEventListener('change', calculateTotalPrice); // Recalculate price

            // Spiciness
            spicinessContainer.innerHTML = '';
            spicinessOptions.forEach((option, index) => {
                const radioDiv = document.createElement('div');
                radioDiv.className = 'flex items-center';
                radioDiv.innerHTML = `
                    <input type="radio" id="spiciness-${option.replace(/\s|\(|\)/g, '')}" name="spiciness" value="${option}"
                           class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300" ${index === 0 ? 'checked' : ''}>
                    <label for="spiciness-${option.replace(/\s|\(|\)/g, '')}" class="ml-2 block text-sm text-gray-900">${option}</label>
                `;
                spicinessContainer.appendChild(radioDiv);
            });
            spicinessContainer.addEventListener('change', calculateTotalPrice); // Recalculate price

            // Vegetables
            vegetablesContainer.innerHTML = '';
            vegetablesOptions.forEach(option => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'flex items-center';
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="veg-${option.replace(/\s|\(|\)/g, '')}" name="vegetable" value="${option}"
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded vegetable-checkbox">
                    <label for="veg-${option.replace(/\s|\(|\)/g, '')}" class="ml-2 block text-sm text-gray-900">${option}</label>
                `;
                vegetablesContainer.appendChild(checkboxDiv);
            });
            vegetablesContainer.querySelectorAll('.vegetable-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    // Handle "ใส่ทุกอย่าง" logic
                    if (e.target.value === 'ใส่ทุกอย่าง' && e.target.checked) {
                        vegetablesOptions.filter(opt => opt !== 'ใส่ทุกอย่าง').forEach(otherOption => {
                            const otherCheckbox = document.getElementById(`veg-${otherOption.replace(/\s|\(|\)/g, '')}`);
                            if (otherCheckbox) {
                                otherCheckbox.checked = true;
                                otherCheckbox.disabled = true;
                            }
                        });
                    } else if (e.target.value === 'ใส่ทุกอย่าง' && !e.target.checked) {
                        vegetablesOptions.filter(opt => opt !== 'ใส่ทุกอย่าง').forEach(otherOption => {
                            const otherCheckbox = document.getElementById(`veg-${otherOption.replace(/\s|\(|\)/g, '')}`);
                            if (otherCheckbox) {
                                otherCheckbox.checked = false;
                                otherCheckbox.disabled = false;
                            }
                        });
                    } else { // If any other vegetable is checked/unchecked
                        const selectAllCheckbox = document.getElementById('veg-ใส่ทุกอย่าง');
                        if (selectAllCheckbox && selectAllCheckbox.checked) {
                            selectAllCheckbox.checked = false; // Uncheck "ใส่ทุกอย่าง" if individual is changed
                            vegetablesOptions.filter(opt => opt !== 'ใส่ทุกอย่าง').forEach(otherOption => {
                                const otherCheckbox = document.getElementById(`veg-${otherOption.replace(/\s|\(|\)/g, '')}`);
                                if (otherCheckbox) {
                                    otherCheckbox.disabled = false;
                                }
                            });
                        }
                    }
                    calculateTotalPrice(); // Recalculate price when vegetables change
                });
            });
        }

        // --- Enforce Main Ingredient Limit ---
        function enforceMainIngredientLimit() {
            const checkboxes = mainIngredientsContainer.querySelectorAll('.main-ingredient-checkbox');
            let checkedCount = 0;
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    checkedCount++;
                }
            });

            if (checkedCount >= 5) {
                checkboxes.forEach(checkbox => {
                    if (!checkbox.checked) {
                        checkbox.disabled = true;
                    }
                });
            } else {
                checkboxes.forEach(checkbox => {
                    checkbox.disabled = false;
                });
            }
        }

        /**
         * Calculates and updates the total price and total cost display.
         */
        function calculateTotalPrice() {
            let currentTotalSellingPrice = 0;
            let currentTotalCost = 0;

            if (selectedRecipe) {
                const quantity = parseInt(selectedMenuQuantityInput.value, 10);
                if (!isNaN(quantity) && quantity > 0) {
                    let baseSellingPrice = selectedRecipe.sellingPricePerUnit || 0;
                    let extraCustomizationSellingPrice = 0;
                    let baseRecipeCost = 0;

                    // Calculate base recipe cost from ingredients with embedded costs
                    if (selectedRecipe.ingredients && Array.isArray(selectedRecipe.ingredients)) {
                        selectedRecipe.ingredients.forEach(ingredient => {
                            baseRecipeCost += (ingredient.costPerUnit || 0) * ingredient.quantityNeeded;
                        });
                    }

                    // Main Ingredients Extra Cost (affecting selling price)
                    mainIngredientsContainer.querySelectorAll('input[name="mainIngredient"]:checked').forEach(checkbox => {
                        extraCustomizationSellingPrice += parseFloat(checkbox.dataset.price || 0);
                    });

                    currentTotalSellingPrice = (baseSellingPrice + extraCustomizationSellingPrice) * quantity;
                    currentTotalCost = baseRecipeCost * quantity; // Cost is just base recipe cost multiplied by quantity
                }
            }
            totalPriceDisplay.textContent = `ราคารวม: ${currentTotalSellingPrice.toFixed(2)} บาท`;
            totalCostDisplay.textContent = `ต้นทุนโดยประมาณ: ${currentTotalCost.toFixed(2)} บาท`;
        }


        // --- Custom Alert Functions ---
        function showCustomAlert(message) {
            customAlertMessage.textContent = message;
            customAlertModal.style.display = 'flex';
        }

        function closeCustomAlert() {
            customAlertModal.style.display = 'none';
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            if (okAlertButton) okAlertButton.addEventListener('click', closeCustomAlert);
            if (closeAlertButton) closeAlertButton.addEventListener('click', closeCustomAlert);

            selectedMenuQuantityInput.addEventListener('input', calculateTotalPrice);

            // Re-calculate total price when any customization changes
            mainIngredientsContainer.addEventListener('change', calculateTotalPrice);
            soupBaseContainer.addEventListener('change', calculateTotalPrice);
            spicinessContainer.addEventListener('change', calculateTotalPrice);
            vegetablesContainer.addEventListener('change', calculateTotalPrice);
        });

        customerOrderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isFirebaseReady) {
                showCustomAlert("ระบบฐานข้อมูลไม่พร้อมใช้งาน. โปรดลองใหม่อีกครั้ง.");
                return;
            }

            if (!selectedRecipe) {
                showCustomAlert("โปรดเลือกเมนูอาหารที่ต้องการสั่ง");
                return;
            }

            const customerName = customerNameInput.value.trim();
            const customerAddress = customerAddressInput.value.trim(); // New
            const customerPhone = customerPhoneInput.value.trim();     // New
            const quantity = parseInt(selectedMenuQuantityInput.value, 10);
            const customerRemarks = customerRemarksInput.value.trim(); // New

            if (isNaN(quantity) || quantity <= 0) {
                showCustomAlert("โปรดระบุจำนวนที่ถูกต้อง (ต้องมากกว่า 0)");
                return;
            }

            // Collect Customizations
            const selectedMainIngredients = Array.from(mainIngredientsContainer.querySelectorAll('input[name="mainIngredient"]:checked'))
                                                .map(checkbox => ({
                                                    name: checkbox.value,
                                                    price: parseFloat(checkbox.dataset.price)
                                                }));

            if (selectedMainIngredients.length !== 5) {
                showCustomAlert("โปรดเลือกวัตถุดิบหลัก 5 อย่าง");
                return;
            }

            const selectedSoupBase = soupBaseContainer.querySelector('input[name="soupBase"]:checked')?.value || 'ไม่ระบุ';
            const selectedSpiciness = spicinessContainer.querySelector('input[name="spiciness"]:checked')?.value || 'ไม่ระระบุ';
            const selectedVegetables = Array.from(vegetablesContainer.querySelectorAll('input[name="vegetable"]:checked'))
                                                  .map(checkbox => checkbox.value);

            let totalExtraSellingCost = 0; // Extra cost from customizations, affecting selling price
            selectedMainIngredients.forEach(item => {
                totalExtraSellingCost += item.price;
            });

            // Calculate base recipe cost from embedded costs in ingredients
            let baseRecipeCostPerUnit = 0;
            if (selectedRecipe.ingredients && Array.isArray(selectedRecipe.ingredients)) {
                selectedRecipe.ingredients.forEach(ingredient => {
                    baseRecipeCostPerUnit += (ingredient.costPerUnit || 0) * ingredient.quantityNeeded;
                });
            }

            const baseItemSellingPrice = selectedRecipe.sellingPricePerUnit || 0;
            const finalSellingPricePerUnit = baseItemSellingPrice + totalExtraSellingCost;
            const orderTotalRevenue = finalSellingPricePerUnit * quantity;
            const orderTotalCost = baseRecipeCostPerUnit * quantity; // Total estimated cost for the order


            // Generate a simple unique order ID for customer tracking
            const timestamp = new Date().getTime();
            const uniqueId = `${timestamp}-${Math.random().toString(36).substring(2, 8)}`;

            try {
                // Add order to 'public_orders' collection
                // This collection needs specific Firestore Security Rules for 'write' access by authenticated users (anonymous)
                // Rule: `match /artifacts/{appId}/public_orders/{document=**} { allow write: if request.auth != null; }`
                const publicOrdersColRef = collection(db, `artifacts/${appId}/public_orders`);
                await addDoc(publicOrdersColRef, {
                    orderId: uniqueId, // Unique ID for customer tracking
                    customerName: customerName,
                    customerAddress: customerAddress,
                    customerPhone: customerPhone,
                    items: [{
                        recipeId: selectedRecipe.id,
                        finishedGoodName: selectedRecipe.finishedGoodName,
                        quantity: quantity,
                        baseSellingPricePerUnit: baseItemSellingPrice, // Base price of the menu item
                        extraCustomizationCost: totalExtraSellingCost,  // Total extra cost from customizations (selling price part)
                        finalSellingPricePerUnit: finalSellingPricePerUnit, // Final price per unit including customization
                        customizations: {
                            mainIngredients: selectedMainIngredients.map(item => item.name), // Store only names for simplicity
                            soupBase: selectedSoupBase,
                            spiciness: selectedSpiciness,
                            vegetables: selectedVegetables,
                            remarks: customerRemarks
                        }
                    }],
                    totalOrderValue: orderTotalRevenue,
                    totalCost: orderTotalCost, // Save the estimated total cost
                    orderDate: new Date().toISOString(),
                    status: 'pending', // Set initial status as 'pending'
                    invoiceNo: null, // Invoice number will be generated by admin app
                    paymentMethod: 'โอนเงิน/เงินสด', // Default, admin will confirm
                    userId: userId // Customer's anonymous ID
                });

                showCustomAlert('บันทึกออเดอร์ของคุณเรียบร้อยแล้ว! โปรดรอการยืนยันจากร้านค้า');
                customerOrderForm.reset();
                selectedMenuQuantityInput.value = '1'; // Reset quantity
                selectedRecipe = null; // Clear selected recipe
                selectedMenuItemDetails.classList.add('hidden');
                customizationOptionsDiv.classList.add('hidden'); // Hide customizations
                renderMenuItems(); // Re-render menu to clear highlights
                calculateTotalPrice(); // Reset total price and cost display
            } catch (error) {
                console.error("Error submitting order:", error);
                showCustomAlert("เกิดข้อผิดพลาดในการบันทึกออเดอร์: " + error.message);
            }
        });

        // Initialize Firebase when the window loads
        window.onload = initFirebase;
    </script>
</body>
</html>
